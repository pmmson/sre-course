# sre-course

учебный проект изучения надежности продуктов, основанный на оригинальном postgres_cluster https://github.com/vitabaks/postgresql_cluster
и приложении ghcr.io/ldest/sre-course/api

Предварительные работы и план работ:
1. создать одну ВМ (виртуальная машина) с публичным IP в предварительной конфигурации 1 CPU | 2 GB | 16 GB SSD. При создании ВМ - зафиксировать имя пользователя
2. сгенерировать ssh ключи для работы с ВМ в ~/.ssh - они потребуются при создании следующих ВМ
3. создаем еще 5 ВМ (например с такой же конфигурацией - 1 CPU | 2 GB | 16 GB SSD) без публичного IP и с аналогичным пользователем п.1. Указываем публичный ключ для подключения
4. Проверяем установку на первой ВМ: git, ansible, helm
5. Клонируем репозиторий например в /home/<ваш пользователь п.1>/<папка развертывания>
6. Переходим в <папку развертывания>/ansible/postgres_cluster. Проверяем и корректируем файл ./ansible/postgres_cluster/inventory - указываем корректные адреса для etcd, postgresdb. А так же пользователя п.1 и путь до ключей ssh
7. В схеме используется haproxy и etcd - для аналогичных схем, дополнительных правок не требуется
8. Разворачиваем приложение командой: ansible-playbook deploy_pgcluster.yml
9. Проверяем итог: http://<ваш публичный IP>:7000/stat
10. Скорректировать pg_hba.conf - добавить правило IP haproxy по аналогии нод pgcluster
11. Подключиться к БД postgres. Создать БД weather.
12. Для разворачивания API необходимо готовый kubeconfig от провайдера с выделенным namespace
13. Переходим в <папку развертывания>/helm/sre-course-api
14. В values.yaml необходимо указать кол-во реплик (replicaCount), корректируем параметр подключения к БД и порт работы (variables)
15. Разворачиваем приложение командой: helm install sre-course-api sre-course-api --kubeconfig=<ваш kubeconfig>
16. Проверяем доступность подов и их работу. При необходимости корректируем ресурсы (resources) в values.yaml. Обновляем API: helm upgrade sre-course-api sre-course-api --kubeconfig=<ваш kubeconfig>
